<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TerraBroker</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f8; font-family: Arial, sans-serif; }
        .navbar { background-color: #4f46e5; }
        .navbar-brand, .nav-link { color: white !important; }
        .card { border-radius: 10px; }
        .activo-img { width: 40px; height: 40px; object-fit: contain; }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">TerraBroker</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" th:text="'Hola, ' + ${#authentication.principal.nombre} + ' ' + ${#authentication.principal.apellido}">Usuario</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/logout}">Cerrar sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <div class="container mt-5">
        <h2>Bienvenido al Dashboard de TerraBroker</h2>
        <p>Compra tus activos favoritos como BTC, ETH, SOL y visualiza sus precios en tiempo real.</p>

        <!-- Información general -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card p-3">
                    <h5>Saldo disponible</h5>
					<p th:text="${usuario.saldo} + ' €'">0 €</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3">
                    <h5>Posiciones</h5>
                    <p th:text="${5} + ' activos'">5 activos</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3">
                    <h5>Transacciones</h5>
                    <p th:text="${10} + ' operaciones'">10 operaciones</p>
                </div>
            </div>
        </div>

        <!-- Tabla de activos para comprar -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card p-3">
                    <h5>Comprar Activos</h5>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Activo</th>
                                <th>Precio Actual</th>
                                <th>Cantidad</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="activo : ${activos}">
                                <td>
                                    <img th:src="@{/img/{img}(img=${activo.imagen})}" class="activo-img" alt="Imagen">
                                </td>
                                <td th:text="${activo.nombre}">BTC</td>
								<td th:id="'precio-' + ${activo.id}" th:text="${activo.precioActual} + ' €'">100 €</td>
                                <td>
                                    <input type="number" min="1" th:id="'cantidad_' + ${activo.id}" class="form-control" value="1">
                                </td>
                                <td>
                                    <button class="btn btn-primary"
                                            th:onclick="'comprarActivo(' + ${activo.id} + ',' + '\'' + '#cantidad_' + ${activo.id} + '\'' + ')'">
                                        Comprar
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
		
		<div class="row mt-5">
		    <div class="col-12">
		        <div class="card p-3">
		            <h5>Mi Cartera</h5>
		            <table class="table table-hover">
		                <thead>
		                    <tr>
		                        <th>Activo</th>
		                        <th>Cantidad</th>
		                        <th>Precio Promedio</th>
		                        <th>Valor Actual</th>
								<th>Ganancias/Perdidas</th>
		                    </tr>
		                </thead>
		                <tbody>
		                    <tr th:each="posicion : ${usuario.cartera.posiciones}">
		                        <td th:text="${posicion.activo.nombre}">BTC</td>
		                        <td th:text="${posicion.cantidad}">1.5</td>
		                        <td th:text="${posicion.precioPromedio} + ' €'">120 €</td>
		                        <td th:text="${posicion.valorActual} + ' €'">180 €</td>
								<td th:text="${posicion.gananciaPerdida} + ' €'">180 €</td>
		                    </tr>
		                    <tr th:if="${#lists.isEmpty(usuario.cartera.posiciones)}">
		                        <td colspan="4" class="text-center">No tienes activos en tu cartera</td>
		                    </tr>
		                </tbody>
		            </table>
		        </div>
		    </div>
		</div>
		
		<div class="card p-3" style="margin-top: 30px;">
		    <h5>Ingresar saldo</h5>
		    <div class="input-group">
		        <input type="number" min="1" id="cantidadSaldo" class="form-control" placeholder="Cantidad a ingresar">
		        <button class="btn btn-success" onclick="ingresarSaldo()">Ingresar</button>
		    </div>
		</div>
		
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script>
	function comprarActivo(activoId, cantidadInputId) {
	    const cantidad = document.getElementById(cantidadInputId.substring(1)).value; // quitar #
	    
	    fetch(`/api/comprar/${activoId}?cantidad=${cantidad}`, { method: 'POST' })
	        .then(response => response.json())
	        .then(data => {
	            if (data.mensaje) {
	                alert(data.mensaje); // Compra correcta
	                window.location.reload();
	            } else if (data.error) {
	                alert("Error: " + data.error); // Mostrar error del servidor
	            }
	        })
	        .catch(err => {
	            console.error(err);
	            alert("Error en la conexión con el servidor");
	        });
	}
	
	function ingresarSaldo() {
	    const cantidad = document.getElementById("cantidadSaldo").value;

	    fetch(`/api/ingresarSaldo?cantidad=${cantidad}`, { method: "POST" })
	        .then(res => res.json())
	        .then(data => {
	            if (data.mensaje) {
	                alert(data.mensaje);
	                window.location.reload();
	            } else {
	                alert("Error: " + data.error);
	            }
	        });
	}
	</script>
	
	<script>
	    // Actualizar precios cada 5 segundos
	    setInterval(() => {
	        fetch('/api/precios')
	            .then(res => res.json())
	            .then(data => {

	                // Por cada activo, actualizar el precio en la tabla
	                Object.keys(data).forEach(id => {
	                    const celda = document.getElementById('precio-' + id);
	                    if (celda) {
	                        celda.innerText = data[id] + ' €';
	                    }
	                });

	            });
	    }, 5000);
	</script>
</body>
</html>