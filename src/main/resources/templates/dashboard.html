<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TerraBroker</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f8; font-family: Arial, sans-serif; }
        .navbar { background-color: #4f46e5; }
        .navbar-brand, .nav-link { color: white !important; }
        .card { border-radius: 10px; }
        .activo-img { width: 40px; height: 40px; object-fit: contain; }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">TerraBroker</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" th:text="'Hola, ' + ${#authentication.principal.nombre} + ' ' + ${#authentication.principal.apellido}">Usuario</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/logout}">Cerrar sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <div class="container mt-5">
        <h2>Bienvenido al Dashboard de TerraBroker</h2>
        <p>Compra tus activos favoritos como BTC, ETH, SOL y visualiza sus precios en tiempo real.</p>

        <!-- Información general -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card p-3">
                    <h5>Saldo disponible</h5>
                    <p th:text="${1000.0} + ' €'">1000 €</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3">
                    <h5>Posiciones</h5>
                    <p th:text="${5} + ' activos'">5 activos</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3">
                    <h5>Transacciones</h5>
                    <p th:text="${10} + ' operaciones'">10 operaciones</p>
                </div>
            </div>
        </div>

        <!-- Tabla de activos para comprar -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card p-3">
                    <h5>Comprar Activos</h5>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Activo</th>
                                <th>Precio Actual</th>
                                <th>Cantidad</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="activo : ${activos}">
                                <td>
                                    <img th:src="@{/img/{img}(img=${activo.imagen})}" class="activo-img" alt="Imagen">
                                </td>
                                <td th:text="${activo.nombre}">BTC</td>
								<td th:id="'precio-' + ${activo.id}" th:text="${activo.precioActual} + ' €'">100 €</td>
                                <td>
                                    <input type="number" min="1" th:id="'cantidad_' + ${activo.id}" class="form-control" value="1">
                                </td>
                                <td>
                                    <button class="btn btn-primary"
                                            th:onclick="'comprarActivo(' + ${activo.id} + ',' + '\'' + '#cantidad_' + ${activo.id} + '\'' + ')'">
                                        Comprar
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
		
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Función para comprar activo
        function comprarActivo(activoId, cantidadInputId) {
            const cantidad = document.getElementById(cantidadInputId.substring(1)).value; // quitar #
            fetch(`/comprar/${activoId}?cantidad=${cantidad}`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        alert('Compra realizada correctamente!');
                        window.location.reload();
                    } else {
                        alert('Error al comprar el activo.');
                    }
                });
        }
    </script>
	
	<script>
	    // Actualizar precios cada 5 segundos
	    setInterval(() => {
	        fetch('/api/precios')
	            .then(res => res.json())
	            .then(data => {

	                // Por cada activo, actualizar el precio en la tabla
	                Object.keys(data).forEach(id => {
	                    const celda = document.getElementById('precio-' + id);
	                    if (celda) {
	                        celda.innerText = data[id] + ' €';
	                    }
	                });

	            });
	    }, 5000);
	</script>
</body>
</html>